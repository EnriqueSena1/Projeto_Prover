name: Deploy via SSH (Docker Swarm)

on:
  push:
    branches:
      - main

jobs:
  deploy-via-ssh:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Deploy no servidor via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            set -e

            # --- 1. DEFINIÇÃO DE CAMINHOS ---
            DOMAIN_DIR="mercadomaranataipi.com.br"
            TARGET_PATH="/home/${{ secrets.SSH_USER }}/$DOMAIN_DIR"
            REPO_URL="https://github.com/EnriqueSena1/Projeto_Prover.git"

            echo "--> Garantindo que a pasta do projeto existe..."
            mkdir -p "$TARGET_PATH"
            cd "$TARGET_PATH"

            # --- 2. CLONE OU UPDATE (CORRETO E SEGURO) ---
            if [ -d ".git" ]; then
              echo "--> Repositório já existe. Atualizando código..."
              git fetch origin main
              git reset --hard origin/main
            else
              echo "--> Inicializando repositório..."
              rm -rf ./*
              git clone "$REPO_URL" .
            fi

            # entra na pasta do projeto
            cd ProjetoProver

            # --- 3. CONFIGURAÇÃO DE AMBIENTE ---
            echo "--> Criando arquivo .env..."
            cat <<EOF > .env
            DB_NAME=${{ secrets.DB_NAME }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            EOF

            # --- 4. BUILD E DEPLOY (Docker Swarm) ---
            echo "--> Build da imagem..."
            docker build -t app-prover:latest .

            echo "--> Deploy no Docker Swarm..."
            docker stack deploy -c docker-compose.yml stack_prover

            echo "--> Forçando atualização do serviço..."
            docker service update --force stack_prover_web
